<!DOCTYPE html>
<html>
	<head>
		<meta name = "viewport" content = "width=device-width, initial-scale=1"/>
		<meta http-equiv = "X-UA-Compatible" content = "IE=edge,chrome=1"/>
		<meta charset = "utf-8"/>
		<script
		  src = "https://code.jquery.com/jquery-3.3.1.js"
		  integrity = "sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
		  crossorigin = "anonymous">
		</script>

		<link href = "https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel = "stylesheet"/>
		<link href = "lib/css/webchat.css" rel = "stylesheet"/>
		<link href = "lib/css/emoji.css" rel = "stylesheet"/>
		<link rel = "stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity = "sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin = "anonymous"/>
		<script src = "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity = "sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin = "anonymous"></script>

		<script type = "text/javascript">
			function getCookie(cname) {
			  var name = cname + "=";
			  var decodedCookie = decodeURIComponent(document.cookie);
			  var ca = decodedCookie.split(';');
			  for(var i = 0; i < ca.length; i++) {
			      var c = ca[i];
			      while (c.charAt(0) == ' ') {
			          c = c.substring(1);
			      }
			      if (c.indexOf(name) == 0) {
			          return c.substring(name.length, c.length);
			      }
			  }
			  return "";
			}

			//Persistence Menu load at the begining
			var persistenceMenu = {
				toggle : function(el){
					$(el).toggle();
				},
				bind : function(){
					$(".persistenceMenu").on("click", function(event){
						persistenceMenu.toggle($(".custom-drop-down"));
					});
				}
			};
			//carousel function for multi slider
			var slider = {
				createSlider : function(el){
					var slideCount = $(el).find('ul li').length;
					var slideWidth = $(el).find('ul li').width();
					var max = -1;
					for(var i = 0; i < $(el).find('ul li').length; i++){
						if(max < $($(el).find("ul li")[i]).height()){
							max = $($(el).find("ul li")[i]).height();
						}
					}
					var slideHeight =max;
					var sliderUlWidth = slideCount * slideWidth;
					$(el).css({ width : slideWidth, height: 'auto'});
					$(el).find('ul').css({ width: sliderUlWidth, marginLeft: "0px" });
					$(el).find('ul li').first().prependTo($(el).find('ul'));
					function moveLeft(el) {
						$($(el).children()[2]).animate({
							left: + slideWidth
						}, 200, function () {
							$($(el).children()[2]).children().last().prependTo(($(el).children()[2]));
							$($(el).children()[2]).css('left', '');
						});
					};
					function moveRight(el) {
						$($(el).children()[2]).animate({
							left: - slideWidth
						}, 200, function () {
							$($(el).children()[2]).children().first().appendTo(($(el).children()[2]));
							$(($(el).children()[2])).css('left', '');
						});
					};
					$(el).find('a.control_prev').click(function (event) {
						moveLeft(event.target.parentNode);
					});
					$(el).find('a.control_next').click(function (event) {
						moveRight(event.target.parentNode);
					});
				}
			};
			//created Views and templates
			var views = {
				carousel : function(obj,timeInMilis){
					var carousel = '<div class="slider_'+obj.intent+"_"+timeInMilis+' slider">'
						+'<a href="javascript:void(0)" class="control_next">></a>'
						+'<a href="javascript:void(0)" class="control_prev"><</a>'
						+'<ul>'
							var li = "";
						for(var i = 0; i < obj.text.length; i++){
						 li +='<li>'
								+'<img max-width="300px" height="150px" class="img_border" src="'+obj.text[i].imgUrl+'"/>'
									+'<div class="slider-title">'+obj.text[i].title+'</div>'
								+'<div class="slider-subtitle">'+obj.text[i].subtitle+'</div>';
								var buttons="";
								for(var j = 0; j < obj.text[i].buttons.length; j++){
										buttons +='	<a target="_blank" href="'+obj.text[i].buttons[j].url+'" type="button" class="sliderbtn btn">'+obj.text[i].buttons[j].name+'</a>'
								}
								li += buttons;
								li+='</li>';
						}
						carousel +=li+'</ul></div>'
						return carousel;
				},
				listTemplate : function(obj){
					var listTemplate = '<div class="list-view">'
						for(var i = 0; i < obj.text.list.length; i++){
								listTemplate += '<div class="list-item">'
								+'<div><span class="title"><b>'+obj.text.list[i].title+'</b></span><img max-width="80px"  src="'+obj.text.list[i].imgUrl+'"/></div>'
								+'<div class="subtitle"><span >'+obj.text.list[i].subTitle+'</span></div>';
								var buttons = "";
								for(var j = 0; j < obj.text.list[i].buttons.length; j++){
									if(obj.text.list[i].buttons[j].text){
										buttons +='<div><a target="_blank" href="'+obj.text.list[i].buttons[j].url+'" onclick="buttonWrite(\''+obj.text.list[i].buttons[j].text+'\')" type="button" class="listbtn btn">'+obj.text.list[i].buttons[j].name+'</a></div>'
									}else{
										buttons +='<div><a target="_blank" href="'+obj.text.list[i].buttons[j].url+'" type="button" class="listbtn btn">'+obj.text.list[i].buttons[j].name+'</a></div>'
									}
								}
								listTemplate += buttons;
								listTemplate +='</div>'
						}
						listTemplate +='<div class="list-item list-item-last">'
							+'<div class="text-center"><a target="_blank" href="'+obj.text.viewMoreButtonUrl+'" type="button">'+obj.text.viewMoreButtonName+'</a></div>'
						+'</div>'
					+'</div>';
					return listTemplate;
				},
				quickReply : function(obj){
					var qReply = '<div class="quickReply">'
						+'<div class=" quickContent">'
							+	'<span>'+obj.text[0].text+'</span>'
						+'</div>';
						for(var j = 0; j < obj.text[0].buttons.length; j++){
								if(j % 2 == 0){
										qReply += '<div class="hiddable" style="text-align:center">';
								}
								qReply +='<button type="button" class="quickreplybtn btn" onclick="quickReplyFunc(\''+obj.text[0].buttons[j].text+'\', event)">'+obj.text[0].buttons[j].name+'</button>';
								if(j % 2 == 1){
									qReply += '</div>'
								}
						}
						qReply +='</div>';
					return qReply;
				},
				genericButtons : function(obj){
					var genericButtons = '<div class="generic_button">'
						  +'<ul >'
							+	'<li>'
										+'<div class="text generic_text"><span>'+obj.text[0].text+'</span></div><div class="genericframe">'
										var buttons = "";
										for(var i = 0; i < obj.text[0].buttons.length; i++){
											if(obj.text[0].buttons[i].text && obj.text[0].buttons[i].url){
												buttons += '<div class="divide"></div><a target="_blank" href="'+obj.text[0].buttons[i].url+'" onclick="buttonWrite(\''+obj.text[0].buttons[i].text+'\')" type="button" class="genericbtn btn">'+obj.text[0].buttons[i].name+'</a>';
											}else if(!obj.text[0].buttons[i].text && obj.text[0].buttons[i].url){
												buttons += '<div class="divide"></div><a target="_blank" href="'+obj.text[0].buttons[i].url+'" type="button" class="genericbtn btn">'+obj.text[0].buttons[i].name+'</a>';
											}else if(obj.text[0].buttons[i].text && !obj.text[0].buttons[i].url){
												buttons += '<div class="divide"></div><a onclick="buttonWrite(\''+obj.text[0].buttons[i].text+'\')" type="button" class="genericbtn btn">'+obj.text[0].buttons[i].name+'</a>';
											}
										}
							genericButtons += buttons;
							genericButtons += '</div>'
								+'</li>'
						 +' </ul>'
						+'</div>'
					return genericButtons;
				},
				attachment : function(obj){
					var attch = '<div class="generic_button">'
						  +'<ul >'
							+	'<li>';
										var buttons = "";
										for(var i = 0; i < obj.text[0].buttons.length; i++){
											if(obj.text[0].buttons[i].text && obj.text[0].buttons[i].url){
												buttons += '<a target="_blank" href="'+obj.text[0].buttons[i].url+'" onclick="buttonWrite(\''+obj.text[0].buttons[i].text+'\')" >'+obj.text[0].buttons[i].name+'</a>';
											}else if(!obj.text[0].buttons[i].text && obj.text[0].buttons[i].url){
												buttons += '<div class="divide"></div><a target="_blank" href="'+obj.text[0].buttons[i].url+'" >'+obj.text[0].buttons[i].name+'</a>';
											}else if(obj.text[0].buttons[i].text && !obj.text[0].buttons[i].url){
												buttons += '<div class="divide"></div><a onclick="buttonWrite(\''+obj.text[0].buttons[i].text+'\')">'+obj.text[0].buttons[i].name+'</a>';
											}
										}
							attch += buttons;
							attch += '</div>'
								+'</li>'
						 +' </ul>'
						+'</div>'
					return attch;
				}
			};
			//load function for messages from Mongo db
			var load = {
				load : function(){
					var request = $.ajax({
						url: "/mongo/findByQueryForMessages/",
						method: "POST",
						data: {
							query : { user_id : { $regex: getCookie("user_id") } }
						},
						dataType: "json"
					});
					request.done(function( msg ) {

						for(var i= msg.length-1; 0 <= i; i--){
							if(msg[i].user_id.indexOf('BOT') >= 0){
								if(msg[i].message.type && msg[i].message.type == 'carousel'){
									var timeInMilis = new Date().getTime();
									$('#container .main-ul').append('<li class="bot">'+views.carousel(msg[i].message,timeInMilis)+'</li>');
									slider.createSlider($(".slider_"+msg[i].message.intent+"_"+timeInMilis));
								}
								else if (msg[i].message.type && msg[i].message.type == 'quickReply'){
									$('#container .main-ul').append('<li class="bot">'+views.quickReply(msg[i].message)+'</li>');
								}
								else if(msg[i].message.type && msg[i].message.type == "listTemplate"){
									$('#container .main-ul').append('<li class="bot">'+views.listTemplate(msg[i].message)+'</li>');
								}
								else if(msg[i].message.type && (msg[i].message.type == "genericButtons")){
									$('#container .main-ul').append('<li class="bot">'+views.genericButtons(msg[i].message)+'</li>');
								}else if (msg[i].message.type && msg[i].message.type == "attachment"){
									$('#container .main-ul').append('<li class="bot">'+views.attachment(msg[i].message)+'</li>');
								}else if(msg[i].message.type && msg[i].message.type == "emoji"){
									$('#container .main-ul').append('<li class="bot"><div class="text"><span>'+msg[i].message.text.image+'</span></div><br/></li>');
								}else{
									$('#container .main-ul').append('<li class="bot"><div class="text"><span>'+msg[i].message.text+'</span></div><br/></li>');
								}
							}else{
								if(msg[i].message.type && msg[i].message.type == 'emoji'){
									$('#container .main-ul').append('<li class="user"><div class="text"><span>'+msg[i].message.text.image+'</span></div><br/></li>');
								}else {
									$('#container .main-ul').append('<li class="user"><div class="text"><span>'+msg[i].message.text+'</span></div><br/></li>');
								}

							}
						}
					});
					request.fail(function( jqXHR, textStatus ) {
						alert( "Request failed: " + textStatus );
					});
				}
			};
			// quickReply show hide and sen message
			var quickReplyFunc = function(text, event){
				$(".input .text-left .emoji-wysiwyg-editor").html(text);
				$(".input .text-left .emoji-wysiwyg-editor").trigger("keypress", [ "Automatically"]);
				var el = event.target || event.srcElement;
				$(el).parent().parent().find(".hiddable").hide();
			};
			var buttonWrite = function(text){
				$(".input .text-left .emoji-wysiwyg-editor").html(text);
				$(".input .text-left .emoji-wysiwyg-editor").trigger("keypress", [ "Automatically"]);
			};
			$(document).ready(function(){
				persistenceMenu.bind();
				//load all messages at mongodb
				load.load();
				//Key press enter after writing message triggers this function

				$("#container").on("shown.bs.collapse", function(){
			  	$("#container").animate({ scrollTop: $('#container ul').height()}, 0);
			  });
			});
		</script>
	</head>


	<body >
		<div class="container">
			<div id="container" >
				<ul class="main-ul">

				</ul>
			</div>
			<div class="input" style="">
					<span class="myicon persistenceMenu glyphicon glyphicon-menu-hamburger" >
						<ul class="custom-drop-down ">
							<li><a href="#">Menu 1</a></li>
							<li role="separator" class="divider"></li>
							<li><a href="#">Menu 2</a></li>
							<li role="separator" class="divider"></li>
							<li><a href="#">Menu 3</a></li>
							<li role="separator" class="divider"></li>
							<li><a href="#">Menu 4</a></li>
						</ul>
					</span>
					<a class="image" href="#"></a>
					<div class="text-left">
						<p class="lead emoji-picker-container">
							<input type = "text" class ="form-control" name = "input" style = "border:none" data-emojiable="true">
						</p>
					</div>
			 </div>
		</div>
		<script src = "lib/js/config.js"></script>
	  <script src = "lib/js/util.js"></script>
	  <script src = "lib/js/jquery.emojiarea.js"></script>
	  <script src = "lib/js/emoji-picker.js"></script>
		<script>

      $(function() {
        // Initializes and creates emoji set from sprite sheet
        window.emojiPicker = new EmojiPicker({
          emojiable_selector : '[data-emojiable=true]',
          assetsPath : '../../lib/img/',
          popupButtonClasses : 'fa fa-smile-o'
        });
        // Finds all elements with `emojiable_selector` and converts them to rich emoji input fields
        // You may want to delay this step if you have dynamically created input fields that appear later in the loading process
        // It can be called as many times as necessary; previously converted input fields will not be converted again
        window.emojiPicker.discover();

				$(".input .text-left .emoji-wysiwyg-editor").on('keypress',function(event, parameter){

						if(event.which == 13 || parameter){
								//user write
								var el = event.target.innerHTML;
								$('#container .main-ul').append('<li class="user"><div class="text"><span>'+el+'</span></div><br/></li>');
								$("#container").animate({ scrollTop: $('#container ul').height()});
								var text = "";

								if(el.match(/(<img\s[^>]*?src\s*=\s*['\"]([^'\"]*?)['\"][^>]*?>)/g) && el.match(/(<img\s[^>]*?src\s*=\s*['\"]([^'\"]*?)['\"][^>]*?>)/g).length <= 1){
									try{
										text = $(el).attr("alt") ? $(el).attr("alt") : el;
									}catch(err){
											text = el;
									}
								}else{
									text = el;
								}

								var request = $.ajax({
								  url : "/api/getMessage/witai/messages",
								  method : "POST",
								  data : {
										"obj" :
										{"transaction" : new Date().getTime(), "message" : {"text" : text }, "user_id" : getCookie("user_id"), "created_date" : new Date()}
									},
								  dataType: "json"
								});
								request.done(function( msg ) {
											event.target.innerHTML = "";
											if(msg.type && msg.type == "carousel"){
												var timeInMilis = new Date().getTime();
												$('#container .main-ul').append('<li class="bot">'+views.carousel(msg,timeInMilis) + '</li>');
												slider.createSlider($(".slider_" + msg.intent+"_"+timeInMilis));
											}
											else if(msg.type && msg.type=="listTemplate"){
												$('#container .main-ul').append('<li class="bot">' + views.listTemplate(msg) + '</li>');
											}
											else if(msg.type && msg.type=="quickReply"){
												$('#container .main-ul').append('<li class="bot">' + views.quickReply(msg) + '</li>');
											}
											else if(msg.type && msg.type=="genericButtons"){
												$('#container .main-ul').append('<li class="bot">' + views.genericButtons(msg) + '</li>');
											}else if (msg.type && msg.type == "attachment"){
												$('#container .main-ul').append('<li class="bot">' + views.attachment(msg) + '</li>');
											}
											else if(msg.type && msg.type=="emoji")
											{
													$('#container .main-ul').append('<li class="bot"><div class="text"><span>' + msg.text.image + '</span></div><br/></li>');
											}else{
												$('#container .main-ul').append('<li class="bot"><div class="text"><span>' + msg.text + '</span></div><br/></li>');
											}
											$("#container").animate({scrollTop: $('#container ul').height()});
								});
								request.fail(function( jqXHR, textStatus ) {
								  alert( "Request failed: " + textStatus );
								});
						}
				});
      });
    </script>
	</body>
</html>
